# SerialPlot 架构图示

本文档提供SerialPlot项目的可视化架构图示，帮助快速理解代码结构。

---

## 1. 整体系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         SerialPlot                              │
│                     实时串口数据绘图软件                          │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   数据层      │      │   业务层      │      │   展示层      │
│  Data Layer  │      │ Business     │      │  UI Layer    │
└──────────────┘      └──────────────┘      └──────────────┘
```

---

## 2. 三层架构详解

### 2.1 数据层 (Data Layer)

```
┌─────────────────────────────────────────────────┐
│               数据输入 (Input)                   │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌───────────┐     ┌────────────┐              │
│  │ QSerialPort│────▶│ QIODevice  │              │
│  └───────────┘     └────────────┘              │
│                           │                     │
│                           ▼                     │
│              ┌─────────────────────┐            │
│              │  AbstractReader     │            │
│              │   (Source接口)      │            │
│              └─────────────────────┘            │
│                      │                          │
│         ┌────────────┼────────────┐             │
│         ▼            ▼            ▼             │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│   │ Binary  │  │  ASCII  │  │ Framed  │        │
│   │ Reader  │  │ Reader  │  │ Reader  │        │
│   └─────────┘  └─────────┘  └─────────┘        │
│                                                 │
└─────────────────────────────────────────────────┘
                      │
                      ▼ SamplePack
                      
┌─────────────────────────────────────────────────┐
│            数据存储 (Storage)                    │
├─────────────────────────────────────────────────┤
│                                                 │
│         ┌─────────────────────┐                 │
│         │      Stream         │                 │
│         │    (Sink接口)       │                 │
│         └─────────────────────┘                 │
│                   │                             │
│      ┌────────────┼────────────┐                │
│      ▼            ▼            ▼                │
│  ┌──────┐    ┌──────┐    ┌──────┐              │
│  │ CH 0 │    │ CH 1 │    │ CH n │              │
│  └──────┘    └──────┘    └──────┘              │
│      │            │            │                │
│      ▼            ▼            ▼                │
│  ┌──────────────────────────────┐               │
│  │       RingBuffer             │               │
│  │   (环形缓冲区，FIFO)          │               │
│  └──────────────────────────────┘               │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 2.2 业务层 (Business Layer)

```
┌─────────────────────────────────────────────────┐
│              Source-Sink 数据流                  │
├─────────────────────────────────────────────────┤
│                                                 │
│    ┌────────┐         ┌────────┐               │
│    │ Source │────────▶│  Sink  │               │
│    └────────┘         └────────┘               │
│        │                   │                    │
│        │                   │                    │
│        │                   ├──▶ follower       │
│        │                   │                    │
│        ├──▶ feedOut()      └──▶ feedIn()       │
│        │                                        │
│        └──▶ connectSink()                       │
│                                                 │
│  实现类:                                         │
│    Source: Reader, Snapshot                    │
│    Sink:   Stream, DataRecorder                │
│                                                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              数据处理流水线                       │
├─────────────────────────────────────────────────┤
│                                                 │
│  Reader ──▶ Stream ──▶ PlotManager              │
│             (Sink)       │                      │
│                │         └──▶ Plot显示           │
│                │                                │
│                └──▶ DataRecorder                │
│                     (follower)                  │
│                     │                           │
│                     └──▶ CSV文件                │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 2.3 展示层 (UI Layer)

```
┌───────────────────────────────────────────────────┐
│                  MainWindow                       │
├───────────────────────────────────────────────────┤
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │         MenuBar / ToolBar                   │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  ┌──────────────┐  ┌────────────────────────┐    │
│  │              │  │                        │    │
│  │  控制面板     │  │      绘图区域          │    │
│  │  (左侧)      │  │    (PlotManager)      │    │
│  │              │  │                        │    │
│  │ ┌──────────┐ │  │  ┌──────────────────┐ │    │
│  │ │PortControl│ │  │  │                  │ │    │
│  │ └──────────┘ │  │  │      Plot        │ │    │
│  │              │  │  │   (Qwt绘图)      │ │    │
│  │ ┌──────────┐ │  │  │                  │ │    │
│  │ │DataFormat│ │  │  └──────────────────┘ │    │
│  │ │  Panel   │ │  │                        │    │
│  │ └──────────┘ │  │  或多图显示模式:        │    │
│  │              │  │  ┌────┐ ┌────┐ ┌────┐ │    │
│  │ ┌──────────┐ │  │  │CH0 │ │CH1 │ │CH2 │ │    │
│  │ │PlotControl│ │  │  └────┘ └────┘ └────┘ │    │
│  │ │  Panel   │ │  │                        │    │
│  │ └──────────┘ │  └────────────────────────┘    │
│  │              │                                │
│  │ ┌──────────┐ │                                │
│  │ │ Command  │ │                                │
│  │ │  Panel   │ │                                │
│  │ └──────────┘ │                                │
│  │              │                                │
│  │ ┌──────────┐ │                                │
│  │ │ Record   │ │                                │
│  │ │  Panel   │ │                                │
│  │ └──────────┘ │                                │
│  │              │                                │
│  └──────────────┘                                │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │         StatusBar (状态栏)                  │  │
│  │  [SPS: xxx] [BPS: xxx] [Samples: xxx]      │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
└───────────────────────────────────────────────────┘
```

---

## 3. 数据流图

### 3.1 完整数据流

```
                     ┌──────────────┐
                     │  QSerialPort │
                     │   (串口)     │
                     └──────┬───────┘
                            │
                            ▼
                     ┌──────────────┐
                     │ AbstractReader│
                     │  readData()  │
                     └──────┬───────┘
                            │
                            │ SamplePack
                            │ (数据包)
                            ▼
        ┌───────────────────────────────────┐
        │           Stream (Sink)           │
        │  - setNumChannels()               │
        │  - feedIn()                       │
        │  - 分发到各通道                    │
        └───────────┬───────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
    ┌─────┐     ┌─────┐     ┌─────┐
    │ CH0 │     │ CH1 │     │ CHn │
    │Ring │     │Ring │     │Ring │
    │Buf  │     │Buf  │     │Buf  │
    └──┬──┘     └──┬──┘     └──┬──┘
       │           │           │
       ▼           ▼           ▼
    ┌────────────────────────────┐
    │    FrameBufferSeries       │
    │   (Qwt数据适配器)          │
    └────────────┬───────────────┘
                 │
                 ▼
    ┌────────────────────────────┐
    │       PlotManager          │
    │  - addCurve()              │
    │  - replot()                │
    └────────────┬───────────────┘
                 │
                 ▼
    ┌────────────────────────────┐
    │         Plot (Qwt)         │
    │  - 显示曲线                │
    │  - 缩放交互                │
    └────────────────────────────┘
```

### 3.2 数据记录流

```
    Stream (Sink)
         │
         │ connectFollower()
         ▼
    DataRecorder (Follower Sink)
         │
         │ feedIn()
         ▼
    ┌────────────────┐
    │  CSV文件写入   │
    │  - 格式化      │
    │  - 时间戳      │
    │  - 实时写入    │
    └────────────────┘
```

### 3.3 快照流

```
    用户点击"快照"按钮
         │
         ▼
    SnapshotManager
         │
         │ takeSnapshot()
         ▼
    创建Snapshot对象
         │
         ├──▶ 复制当前Stream数据
         │
         └──▶ Snapshot作为新Source
                  │
                  ▼
              创建新PlotManager
                  │
                  ▼
              在新窗口显示快照
```

---

## 4. 类层次结构

### 4.1 数据源类

```
Source (接口)
├── AbstractReader
│   ├── BinaryStreamReader
│   ├── AsciiReader
│   ├── FramedReader
│   └── DemoReader
└── Snapshot
```

### 4.2 数据汇类

```
Sink (接口)
├── Stream
└── DataRecorder
```

### 4.3 缓冲区类

```
FrameBuffer (抽象)
├── ResizableBuffer
│   ├── WFrameBuffer (可写)
│   │   └── RingBuffer
│   └── XFrameBuffer (X轴)
│       ├── IndexBuffer
│       └── LinIndexBuffer
└── ReadOnlyBuffer
```

### 4.4 Qt继承关系

```
QWidget
├── QMainWindow
│   └── MainWindow
├── Plot (继承QwtPlot)
└── 各种Panel和Widget
    ├── PortControl
    ├── DataFormatPanel
    ├── PlotControlPanel
    ├── CommandPanel
    └── RecordPanel
```

---

## 5. 模块交互图

### 5.1 启动流程

```
1. main()
    │
    ├──▶ 创建QApplication
    │
    ├──▶ 创建MainWindow
    │    │
    │    ├──▶ 初始化UI组件
    │    │    ├── PortControl
    │    │    ├── DataFormatPanel
    │    │    ├── PlotControlPanel
    │    │    └── ...
    │    │
    │    ├──▶ 创建Stream
    │    │
    │    ├──▶ 创建PlotManager
    │    │
    │    └──▶ 连接信号槽
    │
    └──▶ app.exec() (进入事件循环)
```

### 5.2 打开串口流程

```
1. 用户点击"打开串口"
    │
    ▼
2. PortControl发出信号
    │
    ▼
3. MainWindow::onPortToggled()
    │
    ├──▶ 打开QSerialPort
    │
    ├──▶ 创建对应的Reader
    │    (根据DataFormatPanel的选择)
    │    │
    │    └──▶ reader = new BinaryStreamReader(port)
    │
    ├──▶ 连接数据流
    │    reader->connectSink(&stream)
    │
    └──▶ 启动Reader
         reader->enable(true)
```

### 5.3 数据接收流程

```
1. 串口接收数据
    │
    ▼
2. QSerialPort::readyRead() 信号
    │
    ▼
3. AbstractReader::onDataReady()
    │
    ├──▶ 调用子类的readData()
    │    │
    │    └──▶ 解析数据到SamplePack
    │
    └──▶ feedOut(pack) 发送给Sink
         │
         ▼
4. Stream::feedIn(pack)
    │
    ├──▶ 应用增益和偏移
    │
    ├──▶ 分发到各StreamChannel
    │    │
    │    └──▶ RingBuffer::addSamples()
    │
    └──▶ emit dataAdded()
         │
         ▼
5. PlotManager::replot()
    │
    └──▶ 各Plot刷新显示
```

---

## 6. 设计模式应用

### 6.1 Source-Sink模式 (生产者-消费者)

```
┌──────────┐                  ┌──────────┐
│  Source  │─────feedOut()───▶│   Sink   │
└──────────┘                  └──────────┘
     │                             │
     │ 实现                        │ 实现
     ▼                             ▼
┌──────────┐                  ┌──────────┐
│  Reader  │                  │  Stream  │
└──────────┘                  └──────────┘

优点:
- 解耦数据生产和消费
- 支持一对多连接
- 易于扩展新的Source或Sink
```

### 6.2 Strategy模式 (策略模式)

```
DataFormatPanel 选择不同的Reader策略:

         ┌──────────────┐
         │ MainWindow   │
         └──────┬───────┘
                │
                │ 根据用户选择创建
                ▼
    ┌───────────────────────┐
    │   AbstractReader      │
    └───────────┬───────────┘
                │ 实现
    ┌───────────┼───────────┐
    ▼           ▼           ▼
 Binary      ASCII       Framed
 Reader      Reader      Reader

优点:
- 运行时切换算法
- 各策略独立实现
- 易于添加新策略
```

### 6.3 Observer模式 (观察者模式)

```
Stream发出变化信号，多个组件响应:

┌──────────┐  dataAdded()   ┌──────────────┐
│  Stream  │───────────────▶│ PlotManager  │
└──────────┘                └──────────────┘
     │
     │ numChannelsChanged()
     ├─────────────────────▶┌──────────────┐
     │                      │ ChannelInfo  │
     │                      │    Model     │
     │                      └──────────────┘
     │
     │ numSamplesChanged()
     └─────────────────────▶┌──────────────┐
                            │  UI Panel    │
                            └──────────────┘

通过Qt信号槽实现
```

---

## 7. 并发模型

```
┌────────────────────────────────────────┐
│         主线程 (Main Thread)            │
├────────────────────────────────────────┤
│                                        │
│  ┌──────────────────────────────────┐  │
│  │         Qt Event Loop            │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌──────────────────────────────────┐  │
│  │         UI 更新                  │  │
│  │  - 绘图 (Plot::replot())         │  │
│  │  - 控件响应                      │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌──────────────────────────────────┐  │
│  │       数据处理                    │  │
│  │  - Reader::readData()            │  │
│  │  - Stream::feedIn()              │  │
│  │  - Buffer写入                    │  │
│  └──────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
            │
            │ 通过信号槽异步通信
            ▼
┌────────────────────────────────────────┐
│   Qt内部I/O线程 (QSerialPort)           │
├────────────────────────────────────────┤
│  - 串口数据接收                         │
│  - 发出readyRead()信号                 │
└────────────────────────────────────────┘

注意: SerialPlot主要在主线程工作，
     通过Qt的异步I/O避免阻塞
```

---

## 8. 配置和持久化

```
┌────────────────────────────────────────┐
│        QSettings (INI格式)              │
├────────────────────────────────────────┤
│                                        │
│  [Port]                                │
│  portName=COM1                         │
│  baudRate=115200                       │
│                                        │
│  [DataFormat]                          │
│  readerType=Binary                     │
│  numChannels=4                         │
│                                        │
│  [Plot]                                │
│  numSamples=1000                       │
│  autoScale=true                        │
│  showGrid=true                         │
│                                        │
│  [Channels]                            │
│  channel_0_name=Channel 0              │
│  channel_0_color=#FF0000               │
│  ...                                   │
│                                        │
└────────────────────────────────────────┘
         ▲                  │
         │ load             │ save
         │                  ▼
┌────────────────────────────────────────┐
│         MainWindow                     │
│  - saveAllSettings()                   │
│  - loadAllSettings()                   │
└────────────────────────────────────────┘
         │                  │
         │                  │
    各模块的saveSettings()和loadSettings()
```

---

## 9. 总结

SerialPlot的架构特点:

✅ **清晰的分层**: 数据层、业务层、展示层分离
✅ **模块化设计**: 各模块职责明确，低耦合
✅ **可扩展性**: 易于添加新的Reader、Sink、绘图类型
✅ **Qt最佳实践**: 充分利用信号槽、Model/View
✅ **高效数据处理**: 环形缓冲避免拷贝
✅ **用户友好**: 丰富的UI控件和交互

适合作为:
- Qt应用开发学习项目
- 串口通信应用参考
- 实时数据可视化范例
- 设计模式实践案例
