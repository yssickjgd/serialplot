# SerialPlot 代码架构文档

## 项目概述

SerialPlot是一个用于从串口实时绘制数据的小型简单软件。它基于Qt6框架和Qwt绘图库开发。

- **版本**: 0.13.0
- **编程语言**: C++ (C++17标准)
- **主要框架**: Qt 6
- **绘图库**: Qwt 6.3
- **构建系统**: CMake 3.16+

## 核心架构设计

### 1. 整体架构模式

SerialPlot采用**生产者-消费者(Producer-Consumer)**模式和**源-汇(Source-Sink)**模式来处理数据流：

```
串口设备 → Reader(Source) → Stream(Sink) → PlotManager → 绘图显示
                    ↓
              DataRecorder (数据记录)
```

### 2. 核心设计模式

#### 2.1 Source-Sink模式
- **Source (源)**: 数据生产者，提供数据流
- **Sink (汇)**: 数据消费者，接收并处理数据
- **连接关系**: 一个Source可以连接多个Sink，形成数据流图

#### 2.2 MVC模式
- **Model**: `ChannelInfoModel` - 管理通道信息
- **View**: UI组件（各种Panel和Widget）
- **Controller**: `MainWindow` - 主控制器

## 代码模块分类

### 一、核心数据流模块 (Data Flow Core)

#### 1. 数据源抽象层
| 文件 | 说明 |
|------|------|
| `source.h/cpp` | 数据源基类，所有数据生产者的抽象接口 |
| `sink.h/cpp` | 数据汇基类，所有数据消费者的抽象接口 |
| `samplepack.h/cpp` | 数据包类，封装传输的样本数据 |

#### 2. 数据读取器 (Readers)
所有读取器都继承自`AbstractReader`，负责从设备读取数据并解析：

| 文件 | 说明 |
|------|------|
| `abstractreader.h/cpp` | 读取器抽象基类，实现Source接口 |
| `binarystreamreader.h/cpp` | 二进制流读取器 |
| `binarystreamreadersettings.h/cpp/ui` | 二进制流读取器设置界面 |
| `asciireader.h/cpp` | ASCII/CSV格式读取器 |
| `asciireadersettings.h/cpp/ui` | ASCII读取器设置界面 |
| `framedreader.h/cpp` | 帧格式读取器（支持自定义帧格式）|
| `framedreadersettings.h/cpp/ui` | 帧读取器设置界面 |
| `demoreader.h/cpp` | 演示模式读取器（生成测试数据）|
| `demoreadersettings.h/cpp/ui` | 演示读取器设置界面 |

#### 3. 数据流和缓冲 (Stream & Buffers)
| 文件 | 说明 |
|------|------|
| `stream.h/cpp` | 主要波形存储类，管理多通道同步数据 |
| `streamchannel.h/cpp` | 单个数据通道 |
| `framebuffer.h` | 帧缓冲区抽象接口 |
| `ringbuffer.h/cpp` | 环形缓冲区实现 |
| `indexbuffer.h/cpp` | 索引缓冲区 |
| `linindexbuffer.h/cpp` | 线性索引缓冲区 |
| `readonlybuffer.h/cpp` | 只读缓冲区 |
| `framebufferseries.h/cpp` | 帧缓冲系列（用于Qwt绘图）|

### 二、绘图和可视化模块 (Plotting & Visualization)

#### 1. 绘图核心
| 文件 | 说明 |
|------|------|
| `plot.h/cpp` | 主绘图类，继承自QwtPlot |
| `plotmanager.h/cpp` | 绘图管理器，管理多个绘图窗口 |
| `plotmenu.h/cpp` | 绘图菜单 |
| `plotcontrolpanel.h/cpp/ui` | 绘图控制面板 |

#### 2. 交互组件
| 文件 | 说明 |
|------|------|
| `zoomer.h/cpp` | 缩放工具 |
| `scrollzoomer.h/cpp` | 滚动缩放工具 |
| `scalezoomer.h/cpp` | 刻度缩放工具 |
| `scalepicker.h/cpp` | 刻度选择器 |
| `scrollbar.h/cpp` | 自定义滚动条 |
| `plotsnapshotoverlay.h/cpp` | 快照覆盖层 |

#### 3. 特殊绘图类型
| 文件 | 说明 |
|------|------|
| `barplot.h/cpp` | 柱状图 |
| `barchart.h/cpp` | 柱状图表 |
| `barscaledraw.h/cpp` | 柱状图刻度绘制 |

### 三、用户界面模块 (User Interface)

#### 1. 主窗口
| 文件 | 说明 |
|------|------|
| `main.cpp` | 程序入口点 |
| `mainwindow.h/cpp/ui` | 主窗口类 |

#### 2. 控制面板
| 文件 | 说明 |
|------|------|
| `portcontrol.h/cpp/ui` | 串口控制面板 |
| `portlist.h/cpp` | 串口列表 |
| `dataformatpanel.h/cpp/ui` | 数据格式面板 |
| `commandpanel.h/cpp/ui` | 命令面板 |
| `recordpanel.h/cpp/ui` | 记录面板 |
| `plotcontrolpanel.h/cpp/ui` | 绘图控制面板 |

#### 3. 自定义控件
| 文件 | 说明 |
|------|------|
| `commandwidget.h/cpp/ui` | 命令小部件 |
| `commandedit.h/cpp` | 命令编辑器 |
| `numberformatbox.h/cpp/ui` | 数字格式选择框 |
| `endiannessbox.h/cpp/ui` | 字节序选择框 |
| `ledwidget.h/cpp` | LED指示灯控件 |
| `sneakylineedit.h/cpp` | 特殊单行编辑器 |
| `hidabletabwidget.h/cpp` | 可隐藏标签控件 |
| `bpslabel.h/cpp` | BPS标签（显示数据速率）|

#### 4. 数据视图
| 文件 | 说明 |
|------|------|
| `datatextview.h/cpp/ui` | 数据文本视图 |
| `snapshotview.h/cpp/ui` | 快照视图 |

### 四、功能模块 (Feature Modules)

#### 1. 快照功能
| 文件 | 说明 |
|------|------|
| `snapshot.h/cpp` | 快照类 |
| `snapshotmanager.h/cpp` | 快照管理器 |
| `snapshotview.h/cpp/ui` | 快照视图 |

#### 2. 数据记录
| 文件 | 说明 |
|------|------|
| `datarecorder.h/cpp` | 数据记录器（CSV导出）|
| `recordpanel.h/cpp/ui` | 记录面板 |

#### 3. 更新检查
| 文件 | 说明 |
|------|------|
| `updatechecker.h/cpp` | 更新检查器 |
| `updatecheckdialog.h/cpp/ui` | 更新检查对话框 |
| `versionnumber.h/cpp` | 版本号处理 |

#### 4. 其他工具
| 文件 | 说明 |
|------|------|
| `samplecounter.h/cpp` | 样本计数器 |
| `tooltipfilter.h/cpp` | 工具提示过滤器 |
| `numberformat.h/cpp` | 数字格式化工具 |
| `channelinfomodel.h/cpp` | 通道信息模型 |

### 五、配置和定义 (Configuration & Definitions)

| 文件 | 说明 |
|------|------|
| `defines.h` | 全局定义 |
| `setting_defines.h` | 设置相关定义 |
| `version.h` | 版本信息 |

## 数据流详解

### 1. 数据读取流程

```
QSerialPort (串口)
    ↓
AbstractReader (读取并解析)
    ↓
SamplePack (数据包)
    ↓
Stream (数据流管理)
    ↓
StreamChannel (各个通道)
    ↓
RingBuffer (环形缓冲)
    ↓
FrameBufferSeries (Qwt绘图数据)
    ↓
Plot (显示)
```

### 2. 支持的数据格式

1. **二进制流模式** (`BinaryStreamReader`)
   - 支持类型: (u)int8, (u)int16, (u)int32, float
   - 支持字节序设置
   - 连续数据流

2. **ASCII模式** (`AsciiReader`)
   - CSV格式（逗号分隔值）
   - 每行一个样本

3. **帧模式** (`FramedReader`)
   - 自定义帧头和帧尾
   - 校验和验证
   - 更鲁棒的操作

4. **演示模式** (`DemoReader`)
   - 生成测试正弦波
   - 用于演示和测试

### 3. Source-Sink连接机制

```cpp
// 连接示例
reader->connectSink(&stream);        // Reader → Stream
stream.connectFollower(&recorder);   // Stream → DataRecorder
```

- 一个Source可以连接多个Sink
- Sink可以有followers，形成链式结构
- 数据通过`feedIn`和`feedOut`方法传递

## UI组件架构

### 主窗口结构

```
MainWindow
├── PortControl (串口控制)
├── DataFormatPanel (数据格式面板)
│   ├── BinaryStreamReaderSettings
│   ├── AsciiReaderSettings
│   ├── FramedReaderSettings
│   └── DemoReaderSettings
├── PlotControlPanel (绘图控制)
├── CommandPanel (命令面板)
│   └── CommandWidget (多个命令)
├── RecordPanel (记录面板)
├── PlotManager (绘图管理)
│   └── Plot (一个或多个绘图窗口)
└── SnapshotManager (快照管理)
```

## 线程模型

- **主线程**: UI和绘图
- **串口读取**: 通过Qt的信号槽机制异步处理
- **数据处理**: 在主线程中同步处理（保持简单）

## 构建系统

### CMake配置要点

1. **Qt6集成**: 使用`find_package(Qt6)`
2. **Qwt处理**: 
   - 选项1: 自动下载和构建 (`BUILD_QWT=true`)
   - 选项2: 使用系统安装的Qwt
3. **资源文件**: 使用`qt_add_resources`
4. **平台特定**: Windows有额外的图标资源

### 关键编译选项

```cmake
CMAKE_CXX_STANDARD 17
-DVERSION_STRING
-DVERSION_MAJOR/MINOR/PATCH
-DVERSION_REVISION
-DPROGRAM_NAME
```

## 测试架构

### 测试文件

| 文件 | 测试内容 |
|------|----------|
| `test_stream.cpp` | Stream类和缓冲区测试 |
| `test_readers.cpp` | 各种Reader的测试 |
| `test_recorder.cpp` | DataRecorder测试 |

### 测试框架
- 使用Catch2测试框架 (`catch.hpp`)
- CMake集成: `ENABLE_TESTS=true`

## 设计特点

### 1. 模块化设计
- 清晰的模块边界
- 最小化耦合
- 接口和实现分离

### 2. 可扩展性
- 易于添加新的Reader类型
- 插件式的设置面板
- 灵活的数据格式支持

### 3. 性能优化
- 环形缓冲区避免数据拷贝
- 高效的数据传递机制
- 限制和缓存优化

### 4. Qt最佳实践
- 信号槽机制
- Model/View架构
- 资源管理
- Settings持久化

## 关键类说明

### AbstractReader
所有数据读取器的基类，定义了读取器的接口：
- `enable()`: 启用/禁用读取
- `pause()`: 暂停读取
- `readData()`: 纯虚函数，子类实现具体读取逻辑
- `settingsWidget()`: 返回设置界面

### Stream
核心数据管理类：
- 管理多个`StreamChannel`
- 实现`Sink`接口接收数据
- 支持暂停、清除操作
- 保存/加载通道配置

### PlotManager
绘图管理器：
- 管理单图或多图显示
- 协调多个Plot对象
- 处理缩放同步
- 导出SVG功能

### DataRecorder
CSV数据记录器：
- 实现`Sink`接口
- 支持自定义分隔符
- 时间戳选项
- 浮点精度控制

## 文件统计

- **头文件**: 62个
- **实现文件**: 59个
- **UI文件**: 17个
- **总代码行数**: 约15,000+行

## 依赖关系图

### 核心依赖
```
main.cpp
  └── MainWindow
       ├── Stream (核心)
       ├── PlotManager
       │    └── Plot (Qwt)
       ├── PortControl
       │    └── QSerialPort (Qt)
       ├── AbstractReader
       │    ├── BinaryStreamReader
       │    ├── AsciiReader
       │    ├── FramedReader
       │    └── DemoReader
       └── DataRecorder
```

## 未来扩展点

1. **新的数据格式支持**: 继承`AbstractReader`
2. **自定义绘图类型**: 基于Qwt扩展
3. **数据分析功能**: 添加新的Sink实现
4. **插件系统**: 动态加载Reader

## 总结

SerialPlot是一个结构清晰、设计良好的中小型Qt应用程序。它采用了经典的设计模式，代码组织合理，易于理解和扩展。Source-Sink模式使得数据流清晰可控，模块化的Reader设计使得添加新功能变得简单。
